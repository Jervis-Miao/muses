<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd"
       default-lazy-init="true">

    <description>Shiro安全配置</description>
    <bean id="musesFormAuthenticationFilter" class="com.muses.authc.MusesFormAuthenticationFilter">
        <property name="failureKeyAttribute" value="loginErrorMsg"/>
    </bean>
    <bean id="logoutFilter" class="org.apache.shiro.web.filter.authc.LogoutFilter">
        <property name="redirectUrl" value="/home/index"/>
    </bean>
    <!-- Security 过滤器链配置 -->
    <bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean">
        <property name="securityManager" ref="securityManager"/>
        <property name="loginUrl" value="/unauthorized"/>
        <property name="filters">
            <map>
                <entry key="authc" value-ref="musesFormAuthenticationFilter"/>
                <entry key="logout" value-ref="logoutFilter"/>
            </map>
        </property>
        <property name="filterChainDefinitions">
            <value>
                /login = anon
                /images/** = anon
                /areas/** = anon
                /attachments/** = anon
                /monitor.html = anon
                /logout/result = anon
                /user/** = authc
                /logout = logout
                /** = anon
                * = anon
            </value>
        </property>
    </bean>

    <!-- 保证实现了Shiro内部lifecycle函数的bean执行 -->
    <bean id="lifecycleBeanPostProcessor" class="org.apache.shiro.spring.LifecycleBeanPostProcessor"/>

    <!--<bean id="sessionManager" class="org.apache.shiro.web.session.mgt.DefaultWebSessionManager">-->
    <!--<property name="sessionIdCookie" ref="sessionIdCookie"/>-->
    <!--<property name="globalSessionTimeout" value="1800000"/>-->
    <!--<property name="sessionValidationSchedulerEnabled" value="false"/>-->
    <!--</bean>-->
    <bean id="sessionDAO" class="org.apache.shiro.session.mgt.eis.MemorySessionDAO"/>

    <!-- SessionIDCookie，更改默认Cookie名 -->
    <bean id="sessionIdCookie" class="org.apache.shiro.web.servlet.SimpleCookie">
        <constructor-arg name="name" value="SHIRO-COOKIE"/>
    </bean>

    <!-- 全局Session内部属性配置，应用中可以通过new SessionInternalAttrConfig ，后apply -->
    <bean id="attrConfig" class="com.muses.common.mvc.shiro.session.SessionInternalAttrConfig">
        <property name="excludePatterns">
            <list>
                <value>^_s_.*</value>
            </list>
        </property>
    </bean>

    <!--Session用的request级别缓存 -->
    <bean id="sessionCacheManager" class="com.muses.common.mvc.shiro.cache.SingleValueThreadLocalCacheManager"/>

    <!-- 定时清理僵尸session，Shiro会启用一个后台守护线程定时执行清理操作 用户直接关闭浏览器造成的孤立会话 -->
    <!--  <bean id="sessionValidationScheduler" class="org.apache.shiro.session.mgt.ExecutorServiceSessionValidationScheduler">
        <property name="interval" value="3600000"/>
        <property name="sessionManager" ref="sessionManager"/>
      </bean>-->

    <!-- 用户授权信息Cache, 采用EhCache ,启用Spring缓存管理支持-->
    <!--  <bean id="shiroEhcacheManager" class="org.apache.shiro.cache.ehcache.EhCacheManager">
        <property name="cacheManager" ref="ehCacheManagerFactory"/>
      </bean>-->
    <!--  <bean id="ehCacheManagerFactory" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">
        <property name="configLocation" value="classpath:security/ehcache-shiro.xml"/>
      </bean>-->
    <bean id="usernamePwdCredentialsMatcher" class="com.muses.authc.UsernamePwdCredentialsMatcher"/>
    <bean id="dbRealm" class="com.muses.authc.DbRealm">
        <property name="credentialsMatcher" ref="usernamePwdCredentialsMatcher"/>
    </bean>

    <!--WEB Security 管理 -->
    <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
        <property name="realm" ref="dbRealm"/>
        <!--<property name="cacheManager" ref="shiroEhcacheManager"/>-->
        <!--<property name="sessionManager" ref="sessionManager"/>-->
    </bean>

</beans>